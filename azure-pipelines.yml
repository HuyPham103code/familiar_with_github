trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  name: 'test'

steps:
- checkout: self
  persistCredentials: true

- powershell: |
    Write-Output "Check if the latest commit is a merge commit..."

    git --version
    git status

    $COMMIT_MESSAGE = git log -1 --pretty=%B
    Write-Output "Latest commit message: $COMMIT_MESSAGE"

    if ($COMMIT_MESSAGE -match "Merge") {
        Write-Output "This is a merge commit. Proceeding with task ID extraction..."

        if ($COMMIT_MESSAGE -match "\[Task#(\d+)\]") {
            if ($null -ne $matches[1]) {
                $TASK_ID = $matches[1]
                Write-Output "Found Task ID: $TASK_ID"
                Write-Output "Sending commit to Task ID $TASK_ID..."

                az devops invoke --area workitems --resource workItems `
                --route-parameters id=$TASK_ID `
                --http-method PATCH `
                --in-file comment.json

                if ($LASTEXITCODE -eq 0) {
                    Write-Output "Comment successfully!"
                } else {
                    Write-Output "Failed to comment on Task ID $TASK_ID."
                    exit 1
                }
            } else {
                Write-Output "No Task ID found in commit message (null array)."
            }
        } else {
            Write-Output "No Task ID found in commit message."
        }
    }
    else {
        Write-Output "Not a merge commit. Skipping task ID processing."
    }
  displayName: 'Process merge commit and comment in task ID (PowerShell)'
